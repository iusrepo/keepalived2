From cba49f220eff2025771da9aab766188ceb66c5bf Mon Sep 17 00:00:00 2001
From: Alexandre Cassen <acassen@gmail.com>
Date: Tue, 7 Jan 2014 16:21:58 +0100
Subject: [PATCH 7/7] autoconf: better libnl3 detection

use pkg-config facilities to append CFLAGS related instead of hardcoding
libnl3 path in configure script.
---
 configure                          | 6 +-----
 configure.in                       | 5 +----
 keepalived/libipvs-2.6/Makefile.in | 2 +-
 3 files changed, 3 insertions(+), 10 deletions(-)

diff --git a/configure b/configure
index 90cca7d..66ce48c 100755
--- a/configure
+++ b/configure
@@ -622,7 +622,6 @@ ac_includes_default="\
 ac_subst_vars='LTLIBOBJS
 LIBOBJS
 VRRP_SUPPORT
-INCLUDE_NL
 USE_NL
 IPVS_SUPPORT
 VERSION_DATE
@@ -3975,9 +3974,8 @@ $as_echo "$ac_cv_lib_nl_genl_3_genl_connect" >&6; }
 if test "x$ac_cv_lib_nl_genl_3_genl_connect" = xyes; then :
 
         USE_NL="LIBIPVS_USE_NL"
-        CFLAGS="$CFLAGS $(pkg-config libnl-genl-3.0)"
+        CFLAGS="$CFLAGS $(pkg-config --cflags libnl-genl-3.0)"
 	LIBS="$LIBS $(pkg-config --libs libnl-genl-3.0)"
-	INCLUDE_NL="-I/usr/include/libnl3"
 
 else
 
@@ -4029,7 +4027,6 @@ if test "x$ac_cv_lib_nl_nl_socket_modify_cb" = xyes; then :
         USE_NL="LIBIPVS_USE_NL"
         CFLAGS="$CFLAGS -DFALLBACK_LIBNL1"
         LIBS="$LIBS $(pkg-config --libs libnl-1)"
-	INCLUDE_NL=""
 
 else
 
@@ -4465,7 +4462,6 @@ fi
 
 
 
-
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for an ANSI C-conforming const" >&5
 $as_echo_n "checking for an ANSI C-conforming const... " >&6; }
 if ${ac_cv_c_const+:} false; then :
diff --git a/configure.in b/configure.in
index 364890d..7d97616 100644
--- a/configure.in
+++ b/configure.in
@@ -61,9 +61,8 @@ AC_CHECK_LIB(nl-3, nl_socket_alloc,
     AC_CHECK_LIB(nl-genl-3, genl_connect,
       [
         USE_NL="LIBIPVS_USE_NL"
-        CFLAGS="$CFLAGS $(pkg-config libnl-genl-3.0)"
+        CFLAGS="$CFLAGS $(pkg-config --cflags libnl-genl-3.0)"
 	LIBS="$LIBS $(pkg-config --libs libnl-genl-3.0)"
-	INCLUDE_NL="-I/usr/include/libnl3"
       ],
       [
         AC_MSG_ERROR([libnl-3 is installed but not libnl-gen-3. Please, install libnl-gen-3.])
@@ -75,7 +74,6 @@ AC_CHECK_LIB(nl-3, nl_socket_alloc,
         USE_NL="LIBIPVS_USE_NL"
         CFLAGS="$CFLAGS -DFALLBACK_LIBNL1"
         LIBS="$LIBS $(pkg-config --libs libnl-1)"
-	INCLUDE_NL=""
       ],
       [                                                                                           
         USE_NL="LIBIPVS_DONTUSE_NL"
@@ -279,7 +277,6 @@ AC_SUBST(VERSION)
 AC_SUBST(VERSION_DATE)
 AC_SUBST(IPVS_SUPPORT)
 AC_SUBST(USE_NL)
-AC_SUBST(INCLUDE_NL)
 AC_SUBST(VRRP_SUPPORT)
 
 dnl ----[ Checks for typedefs, structures, and compiler characteristics ]----
diff --git a/keepalived/libipvs-2.6/Makefile.in b/keepalived/libipvs-2.6/Makefile.in
index dfefc7d..14cfa95 100644
--- a/keepalived/libipvs-2.6/Makefile.in
+++ b/keepalived/libipvs-2.6/Makefile.in
@@ -1,7 +1,7 @@
 # Makefile for libipvs
 
 CC		= @CC@
-CFLAGS		= @CFLAGS@ @CPPFLAGS@ @INCLUDE_NL@ -D@USE_NL@ -Wall -Wunused
+CFLAGS		= @CFLAGS@ @CPPFLAGS@ -D@USE_NL@ -Wall -Wunused
 
 export OBJS += libipvs.a
 
-- 
1.8.1.4

